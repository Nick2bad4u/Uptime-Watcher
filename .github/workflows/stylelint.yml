name: StyleLint

on:
    push:
        branches: [main, develop]
        paths:
            - "**/*.css"
            - "**/*.scss"
            - "**/*.sass"
            - "src/**"
            - "electron/**"
            - "shared/**"
            - "docs/**"
            - "stylelint.config.mjs"
            - "package.json"
            - ".github/workflows/stylelint.yml"
    pull_request:
        branches: [main, develop]
        paths:
            - "**/*.css"
            - "**/*.scss"
            - "**/*.sass"
            - "src/**"
            - "electron/**"
            - "shared/**"
            - "docs/**"
            - "stylelint.config.mjs"
            - "package.json"
            - ".github/workflows/stylelint.yml"
    workflow_dispatch:

permissions:
    contents: read
    pull-requests: write
    checks: write

concurrency:
    group: stylelint-${{ github.ref }}
    cancel-in-progress: true

jobs:
    stylelint:
        name: Stylelint Analysis
        runs-on: ubuntu-latest

        steps:
            - name: Harden Runner
              uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
              with:
                  egress-policy: audit

            - name: Checkout Repo Code
              uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: package-lock.json

            - name: Install dependencies
              run: npm ci --prefer-offline --no-audit

            - name: Run Stylelint (GitHub Reporter)
              run: npm run lint:stylelint:github
              continue-on-error: true

            - name: Run Stylelint (Actions Reporter)
              run: npm run lint:stylelint:actions
              continue-on-error: true

            - name: Run Stylelint (Checkstyle Reporter)
              run: npm run lint:stylelint:checkstyle > stylelint-results.xml
              continue-on-error: true

            - name: Upload Stylelint Results
              if: always()
              uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
              with:
                  name: stylelint-results
                  path: |
                      stylelint-results.xml
                  retention-days: 30

            - name: Comment PR with Stylelint Results
              if: github.event_name == 'pull_request' && failure()
              uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
              with:
                  script: |
                      const { execSync } = require('child_process');
                      try {
                          const result = execSync('npm run lint:stylelint:codeframe', { encoding: 'utf8' });
                          const comment = `## üé® Stylelint Results\n\n\`\`\`\n${result}\n\`\`\``;

                          github.rest.issues.createComment({
                              issue_number: context.issue.number,
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              body: comment
                          });
                      } catch (error) {
                          console.log('No stylelint issues found or error occurred:', error.message);
                      }

            - name: Run Stylelint (Final Check)
              run: |
                  if npm run lint:stylelint; then
                      echo "‚úÖ All Stylelint checks passed!"
                  else
                      echo "‚ùå Stylelint found issues that need to be addressed"
                      exit 1
                  fi
