name: Run tests and upload coverage

on:
    push:
        branches: [main, master]
    pull_request:
        branches: [main, master]

jobs:
    test:
        name: Run tests and collect coverage
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Node
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            # Run frontend tests with coverage
            - name: Run frontend tests
              run: npx vitest run --coverage --reporter=verbose

            # Run electron tests with coverage
            - name: Run electron tests  
              run: npx vitest run --config vitest.electron.config.ts --coverage --reporter=verbose

            # Generate JUnit reports for both test suites
            - name: Generate frontend JUnit report
              run: |
                  npx vitest run --reporter=junit \
                    --outputFile=coverage/frontend-test-report.junit.xml

            - name: Generate electron JUnit report
              run: |
                  npx vitest run --config vitest.electron.config.ts --reporter=junit \
                    --outputFile=coverage/electron/electron-test-report.junit.xml

            # Upload frontend coverage to Codecov
            - name: Upload frontend coverage to Codecov
              uses: codecov/codecov-action@v5
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}
                  slug: Nick2bad4u/Uptime-Watcher
                  files: ./coverage/lcov.info
                  flags: frontend
                  name: frontend-coverage
                  fail_ci_if_error: false

            # Upload electron coverage to Codecov  
            - name: Upload electron coverage to Codecov
              uses: codecov/codecov-action@v5
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}
                  slug: Nick2bad4u/Uptime-Watcher
                  files: ./coverage/electron/lcov.info
                  flags: electron
                  name: electron-coverage
                  fail_ci_if_error: false

            # Upload test results
            - name: Upload frontend test results to Codecov
              if: ${{ !cancelled() }}
              uses: codecov/test-results-action@v1
              with:
                  files: coverage/frontend-test-report.junit.xml
                  token: ${{ secrets.CODECOV_TOKEN }}
                  flags: frontend

            - name: Upload electron test results to Codecov
              if: ${{ !cancelled() }}
              uses: codecov/test-results-action@v1
              with:
                  files: coverage/electron/electron-test-report.junit.xml
                  token: ${{ secrets.CODECOV_TOKEN }}
                  flags: electron
