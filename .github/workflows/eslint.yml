# This GitHub Actions workflow is designed to run ESLint, a tool for identifying and reporting on patterns found in ECMAScript/JavaScript code.
# The workflow is triggered on push and pull request events to the "main" branch, as well as on a scheduled basis every Saturday at 12:25 PM UTC.
# It includes the following steps:
# 1. Harden Runner: Uses the step-security/harden-runner action to enhance the security of the GitHub Actions runner.
# 2. Checkout code: Uses the actions/checkout action to check out the repository code.
# 3. Cache node modules: Uses the actions/cache action to cache the '.node_modules' directory to speed up workflow runs.
# 4. Install all required ESLint plugins: Installs ESLint, the Microsoft SARIF formatter for ESLint, and all required ESLint plugins and configs used in eslint.config.js in the . directory.
# 5. Run ESLint: Executes ESLint with the specified configuration and file extensions, outputting the results in SARIF format.
# 6. Upload analysis results to GitHub: Uses the github/codeql-action/upload-sarif action to upload the ESLint results to GitHub for analysis.
# 7. Upload ESLint SARIF as artifact: Uses the actions/upload-artifact action to upload the ESLint SARIF file as an artifact.
#
# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.
# ESLint is a tool for identifying and reporting on patterns
# found in ECMAScript/JavaScript code.
# More details at https://github.com/eslint/eslint
# and https://eslint.org

# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: ESLint

on:
    push:
    pull_request:
    workflow_dispatch:

permissions:
    contents: read

concurrency:
    group: eslint-${{ github.ref }}
    cancel-in-progress: false

jobs:
    eslint:
        name: Run eslint scanning
        runs-on: ubuntu-latest
        permissions:
            contents: read
            security-events: write
            actions: read # only required for a private repository by github/codeql-action/upload-sarif to get the Action run status
        steps:
            - name: Harden Runner
              uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
              with:
                  egress-policy: audit

            - name: Checkout code
              uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

            - name: Cache node modules
              uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5.0.2
              with:
                  path: .node_modules
                  key: ${{ runner.os }}-.-node-modules-${{ hashFiles('.package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-.-node-modules-

            - name: Install all required ESLint plugins
              run: |
                  cd .
                  npm install -D
                  npm install typescript-eslint eslint-plugin-import @microsoft/eslint-formatter-sarif

            - name: Check IPC artifacts
              run: npm run check:ipc

            - name: Run ESLint
              env:
                  SARIF_ESLINT_IGNORE_SUPPRESSED: "true"
              run: |
                  rm -f eslint-results.sarif
                  npx eslint . --ignore-pattern libs --format stylish
                  npx eslint . --ignore-pattern libs --format @microsoft/eslint-formatter-sarif --output-file eslint-results.sarif
              working-directory: .
              continue-on-error: true

            - name: Run ESLint Microsoft Sarirf Format
              env:
                  SARIF_ESLINT_IGNORE_SUPPRESSED: "true"
              run: |
                  npx eslint . --ignore-pattern dist --format @microsoft/eslint-formatter-sarif --output-file eslint-results.sarif
              working-directory: .
              continue-on-error: true

            - name: Verify IPC documentation artifacts
              run: npm run check:ipc
              working-directory: .

            - name: Upload analysis results to GitHub
              uses: github/codeql-action/upload-sarif@cdefb33c0f6224e58673d9004f47f7cb3e328b89 # v2.27.0
              with:
                  sarif_file: eslint-results.sarif
                  wait-for-processing: true

            - name: Upload ESLint SARIF as artifact
              uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
              with:
                  name: eslint-results
                  path: eslint-results.sarif
