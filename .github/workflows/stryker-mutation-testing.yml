name: Stryker Mutation Testing

# Run on pushes to main and PRs, plus manual trigger
on:
    push:
        branches: [main]
        paths:
            # Only run when source code changes
            - "src/**"
            - "electron/**"
            - "shared/**"
            - "package.json"
            - "package-lock.json"
            - "stryker.config.mjs"
            - "vitest.config.ts"
            - "tsconfig*.json"
    pull_request:
        branches: [main]
        paths:
            - "src/**"
            - "electron/**"
            - "shared/**"
            - "package.json"
            - "package-lock.json"
            - "stryker.config.mjs"
            - "vitest.config.ts"
            - "tsconfig*.json"
    workflow_dispatch:
        inputs:
            branch:
                description: "Branch to run mutation testing against"
                required: true
                default: "main"
            stryker-concurrency:
                description: "Stryker concurrency (number of workers)"
                required: false
                default: "4"
            artifact-retention-days:
                description: "Number of days to retain mutation testing artifacts (default: 30)"
                required: false
                default: "30"
            timeout-minutes:
                description: "Timeout for mutation testing job (default: 120 minutes)"
                required: false
                default: "120"

# Limit concurrency to avoid running multiple mutation tests simultaneously
# The concurrency group uses `${{ github.ref }}` so that only one mutation test runs per branch or PR at a time.
# This prevents overlapping runs for the same branch or PR, ensuring results are not corrupted by concurrent executions.
concurrency:
    group: stryker-${{ github.ref }}
    cancel-in-progress: true

permissions:
    contents: read
    issues: write
    pull-requests: write

jobs:
    mutation-testing:
        name: Run Stryker Mutation Testing
        runs-on: windows-latest
        timeout-minutes: ${{ github.event.inputs.timeout-minutes != '' && github.event.inputs.timeout-minutes || 120 }} # Configurable timeout for large projects

        steps:
            - name: Harden the runner
              uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
              with:
                  egress-policy: audit

            - name: Checkout repository
              uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
              with:
                  ref: ${{ github.event.inputs.branch != '' && github.event.inputs.branch || github.ref }}
                  # Fetch full history for better incremental mode performance
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Cache Stryker incremental file
              uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
              with:
                  path: reports/stryker-incremental.json
                  key: stryker-incremental-${{ github.sha }}
                  restore-keys: |
                      stryker-incremental-${{ github.ref_name }}-
                      stryker-incremental-

            - name: Install dependencies
              run: npm ci

            # NEW STEP: Run full test suite to ensure baseline stability before mutation testing
            # This prevents Stryker from running on a failing test suite, which would produce unreliable results
            - name: Run test suite
              id: run-tests
              shell: pwsh
              run: |
                  Write-Host "🧪 Running test suite to validate baseline..."
                  try {
                      npm test
                      Write-Host "✅ All tests passed!"
                      echo "tests_status=passed" >> $env:GITHUB_OUTPUT
                  }
                  catch {
                      Write-Host "❌ Some tests failed!"
                      Write-Host "Failed test output:"
                      Write-Host $_.Exception.Message
                      echo "tests_status=failed" >> $env:GITHUB_OUTPUT
                      echo "test_error<<EOF" >> $env:GITHUB_OUTPUT
                      echo $_.Exception.Message >> $env:GITHUB_OUTPUT
                      echo "EOF" >> $env:GITHUB_OUTPUT
                  }
              continue-on-error: true # Continue to report failure details

            - name: Report test failures
              if: steps.run-tests.outputs.tests_status == 'failed'
              shell: pwsh
              run: |
                  Write-Host "⚠️  Tests failed. Mutation testing cannot run on a failing test suite."
                  Write-Host "Test failure details:"
                  Write-Host "${{ steps.run-tests.outputs.test_error }}"
                  Write-Host ""
                  Write-Host "Please fix the failing tests before running mutation testing."

                  # Create a summary for the workflow
                  echo "## 🚨 Test Suite Failed" >> $env:GITHUB_STEP_SUMMARY
                  echo "" >> $env:GITHUB_STEP_SUMMARY
                  echo "Mutation testing was skipped because the test suite is failing." >> $env:GITHUB_STEP_SUMMARY
                  echo "" >> $env:GITHUB_STEP_SUMMARY
                  echo "### Test Errors:" >> $env:GITHUB_STEP_SUMMARY
                  echo '```' >> $env:GITHUB_STEP_SUMMARY
                  echo "${{ steps.run-tests.outputs.test_error }}" >> $env:GITHUB_STEP_SUMMARY
                  echo '```' >> $env:GITHUB_STEP_SUMMARY
                  echo "" >> $env:GITHUB_STEP_SUMMARY
                  echo "Fix these test failures and re-run the workflow." >> $env:GITHUB_STEP_SUMMARY

            # MODIFIED: Conditionally run Stryker only if tests passed
            # Uses the output from the test step to skip if tests failed
            - name: Run Stryker mutation testing
              if: steps.run-tests.outputs.tests_status == 'passed' # Only run if tests passed
              env:
                  # 🔑 Dashboard API Key - Set this as a repository secret
                  STRYKER_DASHBOARD_API_KEY: ${{ secrets.STRYKER_DASHBOARD_API_KEY }}
                  # 📊 GitHub Actions automatically provides these for dashboard reporting
                  # GITHUB_REPOSITORY and GITHUB_SHA are automatically available
                  CI: true
              shell: pwsh
              run: |
                  Write-Host "🧬 Starting Stryker mutation testing..."
                  Write-Host "📊 Project: github.com/${{ github.repository }}"
                  Write-Host "🏷️ Version: ${{ github.ref_name }}-${{ github.sha }}"
                  Write-Host "📁 Reports will be saved to: reports/mutation/"

                  # Run Stryker with dashboard reporting enabled
                  # Use workflow input or default to 4
                  $CONCURRENCY = "${{ github.event.inputs.stryker-concurrency }}"
                  if ([string]::IsNullOrEmpty($CONCURRENCY)) {
                    $CONCURRENCY = "4"
                  }
                  Write-Host "Using Stryker concurrency: $CONCURRENCY"
                  npx stryker run --configFile stryker.config.mjs --concurrency "$CONCURRENCY"
              continue-on-error: true

            - name: Verify Stryker report files
              shell: pwsh
              run: |
                  $expectedFiles = @(
                    "coverage/stryker.json",
                    "coverage/stryker.html",
                    "coverage/events",
                    "reports/stryker-incremental.json"
                  )
                  $missing = $expectedFiles | Where-Object { -not (Test-Path $_) }
                  if ($missing.Count -gt 0) {
                    Write-Host "⚠️ Warning: The following Stryker report files are missing:`n$($missing -join "`n")"
                  } else {
                    Write-Host "✅ All expected Stryker report files are present."
                  }

            - name: Upload mutation testing reports
              if: always() # Upload reports even if Stryker fails
              uses: actions/upload-artifact@ef09cdac3e2d3e60d8ccadda691f4f1cec5035cb # v5.0.0
              with:
                  name: stryker-reports-${{ github.sha }}
                  path: |
                      coverage/stryker.json
                      coverage/stryker.html
                      coverage/events
                      reports/stryker-incremental.json
                  retention-days: ${{ github.event.inputs.artifact-retention-days != '' && github.event.inputs.artifact-retention-days || 30 }}

            # Adds a comment to the pull request summarizing mutation testing results.
            # Reads the Stryker mutation report, calculates the mutation score, and posts a status comment.
            # If the report is missing, notifies the PR with a warning and instructions.
            - name: Comment mutation score on PR
              if: always() && github.event_name == 'pull_request'
              uses: actions/github-script@v8
              with:
                  script: |
                      const fs = require('fs');
                      const path = require('path');
                      const reportPath = path.join('coverage', 'stryker.json');

                      let comment;
                      if (fs.existsSync(reportPath)) {
                        const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
                        const score = Math.round(report.mutationScore || 0);

                        let scoreStatus;
                        if (score >= 85) {
                          scoreStatus = '🟢 Excellent mutation coverage!';
                        } else if (score >= 70) {
                          scoreStatus = '🟡 Good mutation coverage';
                        } else {
                          scoreStatus = '🔴 Mutation coverage needs improvement';
                        }

                        // Sanitize branch name for dashboard URL
                        const rawBranch = process.env.GITHUB_REF_NAME || '${{ github.ref_name }}';
                        const safeBranch = rawBranch.replace(/[^a-zA-Z0-9._-]/g, '-');
                        const dashboardUrl = `https://dashboard.stryker-mutator.io/reports/github.com/${{ github.repository }}/${safeBranch}-${{ github.sha }}`;

                        comment = `## 🧬 Mutation Testing Results

                        **Mutation Score:** ${score}%

                        📊 [View detailed report](${dashboardUrl})

                        ${scoreStatus}
                        `;
                      } else {
                        comment = `## 🧬 Mutation Testing Results

                        ⚠️ Mutation report not found. Mutation testing results are unavailable for this PR.

                        Please check the workflow logs for details or re-run the mutation testing workflow if needed.
                        `;
                      }

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: comment
                      });

            # MODIFIED: Update final check to handle cases where Stryker was skipped due to test failures or produced invalid output
            - name: Check mutation score threshold
              if: always()
              shell: pwsh
              run: |
                  $mutationReport = "coverage/stryker.json"
                  if (Test-Path $mutationReport) {
                    $score = (Get-Content $mutationReport | ConvertFrom-Json).mutationScore
                    if ($null -eq $score) { $score = 0 }
                    Write-Host "🧬 Mutation score: $score%"
                    if ($score -lt 60) {
                      Write-Host "❌ Mutation score $score% is below the minimum threshold of 60%"
                      $reportUrl = "https://dashboard.stryker-mutator.io/reports/github.com/${{ github.repository }}/${{ github.ref_name }}-${{ github.sha }}"
                      Write-Host "🔍 Check the detailed report for areas that need better test coverage: $reportUrl"
                      exit 1
                    } else {
                      Write-Host "✅ Mutation score $score% meets the quality threshold"
                    }
                  } elseif ("${{ steps.run-tests.outcome }}" -ne "success") {
                    Write-Host "⚠️ Test suite failed - Stryker was skipped to avoid unreliable mutation results"
                    Write-Host "🔧 Fix the failing tests before running mutation testing"
                    exit 1
                  } else {
                    Write-Host "⚠️ No mutation report found - Stryker may have failed to complete"
                    exit 1
                  }
