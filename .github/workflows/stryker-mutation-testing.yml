name: Stryker Mutation Testing

# Run on pushes to main and PRs, plus manual trigger
on:
  push:
    branches: [main]
    paths:
      # Only run when source code changes
      - "src/**"
      - "electron/**"
      - "shared/**"
      - "package.json"
      - "package-lock.json"
      - "stryker.config.mjs"
      - "vitest.config.ts"
      - "tsconfig*.json"
  pull_request:
    branches: [main]
    paths:
      - "src/**"
      - "electron/**"
      - "shared/**"
      - "package.json"
      - "package-lock.json"
      - "stryker.config.mjs"
      - "vitest.config.ts"
      - "tsconfig*.json"
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to run mutation testing against"
        required: true
        default: "main"

# Limit concurrency to avoid running multiple mutation tests simultaneously
concurrency:
  group: stryker-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  mutation-testing:
    name: Run Stryker Mutation Testing
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Mutation testing can take a while

    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}
          # Fetch full history for better incremental mode performance
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: "20"
          cache: "npm"

      - name: Cache Stryker incremental file
        uses: actions/cache@6849a6489940f00c2f30c0fb92c6274307ccb58a # v4.1.2
        with:
          path: reports/stryker-incremental.json
          key: stryker-incremental-${{ github.sha }}
          restore-keys: |
            stryker-incremental-${{ github.ref_name }}-
            stryker-incremental-

      - name: Install dependencies
        run: npm ci

      - name: Create reports directory
        run: mkdir -p reports/mutation

      - name: Run Stryker mutation testing
        env:
          # ğŸ”‘ Dashboard API Key - Set this as a repository secret
          STRYKER_DASHBOARD_API_KEY: ${{ secrets.STRYKER_DASHBOARD_API_KEY }}
          # ğŸ“Š GitHub Actions automatically provides these for dashboard reporting
          # GITHUB_REPOSITORY and GITHUB_SHA are automatically available
          CI: true
        run: |
          echo "ğŸ§¬ Starting Stryker mutation testing..."
          echo "ğŸ“Š Project: github.com/${{ github.repository }}"
          echo "ğŸ·ï¸ Version: ${{ github.ref_name }}-${{ github.sha }}"
          echo "ğŸ“ Reports will be saved to: reports/mutation/"

          # Run Stryker with dashboard reporting enabled
          npx stryker run --concurrency 4
        continue-on-error: true  # Don't fail the build if mutation score is below threshold

      - name: Upload mutation testing reports
        if: always()  # Upload reports even if Stryker fails
        uses: actions/upload-artifact@ef09cdac3e2d3e60d8ccadda691f4f1cec5035cb # v5.0.0
        with:
          name: stryker-reports-${{ github.sha }}
          path: |
            reports/mutation/
            reports/stryker-incremental.json
          retention-days: 30


      - name: Comment mutation score on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'reports/mutation/mutation.json';

            if (fs.existsSync(path)) {
              const report = JSON.parse(fs.readFileSync(path, 'utf8'));
              const score = Math.round(report.thresholds?.high || 0);

              const comment = `## ğŸ§¬ Mutation Testing Results

              **Mutation Score:** ${score}%

              ğŸ“Š [View detailed report](https://dashboard.stryker-mutator.io/reports/github.com/${{ github.repository }}/${{ github.ref_name }}-${{ github.sha }})

              ${score >= 85 ? 'ğŸŸ¢ Excellent mutation coverage!' :
                score >= 70 ? 'ğŸŸ¡ Good mutation coverage' :
                'ğŸ”´ Mutation coverage needs improvement'}
              `;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

      - name: Check mutation score threshold
        if: always()
        run: |
          if [ -f "reports/mutation/mutation.json" ]; then
            SCORE=$(cat reports/mutation/mutation.json | jq -r '.thresholds.high // 0')
            echo "ğŸ§¬ Mutation score: ${SCORE}%"

            if [ "$SCORE" -lt 60 ]; then
              echo "âŒ Mutation score ${SCORE}% is below the minimum threshold of 60%"
              echo "ğŸ” Check the detailed report for areas that need better test coverage"
              exit 1
            else
              echo "âœ… Mutation score ${SCORE}% meets the quality threshold"
            fi
          else
            echo "âš ï¸ No mutation report found - Stryker may have failed to complete"
            exit 1
          fi
