name: Stryker Mutation Testing

# Run on pushes to main and PRs, plus manual trigger
on:
    push:
        branches: [main]
        paths:
            # Only run when source code changes
            - "src/**"
            - "electron/**"
            - "shared/**"
            - "package.json"
            - "package-lock.json"
            - "stryker.config.mjs"
            - "vitest.config.ts"
            - "tsconfig*.json"
    pull_request:
        branches: [main]
        paths:
            - "src/**"
            - "electron/**"
            - "shared/**"
            - "package.json"
            - "package-lock.json"
            - "stryker.config.mjs"
            - "vitest.config.ts"
            - "tsconfig*.json"
    workflow_dispatch:
        inputs:
            branch:
                description: "Branch to run mutation testing against"
                required: true
                default: "main"
            stryker-concurrency:
                description: "Stryker concurrency (number of workers)"
                required: false
                default: "1"
            artifact-retention-days:
                description: "Number of days to retain mutation testing artifacts (default: 30)"
                required: false
                default: "30"
            timeout-minutes:
                description: "Timeout for mutation testing job (default: 120 minutes)"
                required: false
                default: "120"
            mutation-score-threshold:
                description: "Minimum mutation score threshold to pass (default: 60)"
                required: false
                default: "60"
            allow-test-failures:
                description: "Allow mutation testing to run even if some tests fail (default: false)"
                required: false
                default: false
                type: boolean

# Limit concurrency to avoid running multiple mutation tests simultaneously
# The concurrency group uses `${{ github.ref }}` so that only one mutation test runs per branch or PR at a time.
# This prevents overlapping runs for the same branch or PR, ensuring results are not corrupted by concurrent executions.
concurrency:
    group: stryker-${{ github.ref }}
    cancel-in-progress: true

permissions:
    # Allows workflow to read repository contents (required for checkout and artifact upload)
    contents: read
    # Allows workflow to create comments/issues for reporting mutation results and test failures
    issues: write
    # Allows workflow to comment on pull requests with mutation testing results
    pull-requests: write

jobs:
    mutation-testing:
        name: Run Stryker Mutation Testing
        runs-on: windows-latest
        timeout-minutes: ${{ fromJSON(github.event.inputs.timeout-minutes || '120') }} # Configurable timeout for large projects

        steps:
            - name: Harden the runner
              uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
              with:
                  egress-policy: audit

            - name: Checkout repository
              uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
              with:
                  ref: ${{ github.event.inputs.branch || github.ref }}
                  # Fetch full history for better incremental mode performance
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Cache Stryker incremental file
              uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
              with:
                  path: reports/stryker-incremental.json
                  key: stryker-incremental-${{ github.sha }}
                  restore-keys: |
                      stryker-incremental-${{ github.ref_name }}-
                      stryker-incremental-

            - name: Install dependencies
              run: npm ci

            # NEW STEP: Run full test suite to ensure baseline stability before mutation testing
            # This prevents Stryker from running on a failing test suite, which would produce unreliable results
            - name: Run test suite
              id: run-tests
              shell: pwsh
              env:
                  # üöÄ Allocate more memory for CI environment
                  NODE_OPTIONS: --max_old_space_size=8192
              run: |
                  Write-Host "üß™ Running test suite to validate baseline..."
                  Write-Host "üíæ Node memory allocation set to 8GB for CI environment"
                  try {
                      npm test
                      Write-Host "‚úÖ All tests passed!"
                      echo "tests_status=passed" >> $env:GITHUB_OUTPUT
                  }
                  catch {
                      Write-Host "‚ùå Some tests failed!"
                      Write-Host "Failed test output:"
                      Write-Host $_.Exception.Message
                      echo "tests_status=failed" >> $env:GITHUB_OUTPUT
                      echo "test_error<<EOF" >> $env:GITHUB_OUTPUT
                      echo $_.Exception.Message >> $env:GITHUB_OUTPUT
                      echo "EOF" >> $env:GITHUB_OUTPUT
                  }
              continue-on-error: true # Continue to report failure details

            - name: Report test failures
              if: steps.run-tests.outputs.tests_status == 'failed'
              shell: pwsh
              run: |
                  Write-Host "‚ö†Ô∏è  Tests failed. Mutation testing cannot run on a failing test suite."
                  Write-Host "Test failure details:"
                  Write-Host "${{ steps.run-tests.outputs.test_error }}"
                  Write-Host ""
                  Write-Host "Please fix the failing tests before running mutation testing."

                  # Create a summary for the workflow
                  echo "## üö® Test Suite Failed" >> $env:GITHUB_STEP_SUMMARY
                  echo "" >> $env:GITHUB_STEP_SUMMARY
                  echo "Mutation testing was skipped because the test suite is failing." >> $env:GITHUB_STEP_SUMMARY
                  echo "" >> $env:GITHUB_STEP_SUMMARY
                  echo "### Test Errors:" >> $env:GITHUB_STEP_SUMMARY
                  echo '```' >> $env:GITHUB_STEP_SUMMARY
                  echo "${{ steps.run-tests.outputs.test_error }}" >> $env:GITHUB_STEP_SUMMARY
                  echo '```' >> $env:GITHUB_STEP_SUMMARY
                  echo "" >> $env:GITHUB_STEP_SUMMARY
                  echo "Fix these test failures and re-run the workflow." >> $env:GITHUB_STEP_SUMMARY

            # MODIFIED: Conditionally run Stryker only if tests passed OR if test failures are explicitly allowed
            # Uses the output from the test step to skip if tests failed
            - name: Run Stryker mutation testing
              if: steps.run-tests.outputs.tests_status == 'passed' || github.event.inputs.allow-test-failures == 'true' # Run if tests passed OR failures allowed
              env:
                  # üîë Dashboard API Key - Set this as a repository secret
                  STRYKER_DASHBOARD_API_KEY: ${{ secrets.STRYKER_DASHBOARD_API_KEY }}
                  # üìä GitHub Actions automatically provides these for dashboard reporting
                  # GITHUB_REPOSITORY and GITHUB_SHA are automatically available
                  CI: true
                  # üöÄ Allocate additional memory for Stryker mutation testing in CI (increased to 12GB for stability)
                  NODE_OPTIONS: --max_old_space_size=12288
              shell: pwsh
              run: |
                  Write-Host "üß¨ Starting Stryker mutation testing..."
                  Write-Host "üìä Project: github.com/${{ github.repository }}"
                  Write-Host "üè∑Ô∏è Version: ${{ github.ref_name }}-${{ github.sha }}"
                  Write-Host "üìÅ Reports will be saved to: reports/mutation/"
                  Write-Host "üíæ Node memory allocation set to 12GB for CI environment"

                  # Check if running with test failures allowed
                  if ("${{ github.event.inputs.allow-test-failures }}" -eq "true" -and "${{ steps.run-tests.outputs.tests_status }}" -eq "failed") {
                    Write-Host "‚ö†Ô∏è  NOTICE: Running mutation testing despite test failures (explicitly allowed)"
                    Write-Host "üîß Results may be unreliable due to failing baseline tests"
                  }

                  # Run Stryker with dashboard reporting enabled
                  # Use workflow input with conservative default of 1 for CI stability
                  $CONCURRENCY = "${{ github.event.inputs.stryker-concurrency }}"
                  if ([string]::IsNullOrEmpty($CONCURRENCY)) {
                    $CONCURRENCY = "1"
                  }
                  Write-Host "üîß Using Stryker concurrency: $CONCURRENCY (optimized for CI)"

                  # Add additional performance optimizations for CI
                  Write-Host "‚ö° Applying CI performance optimizations..."
                  try {
                    # Added timeout (10 minutes per mutation) and max concurrent test runners to prevent resource exhaustion
                    npx stryker run --concurrency "$CONCURRENCY" --maxConcurrentTestRunners 1 --timeoutMS 600000 --logLevel warn --fileLogLevel error
                    Write-Host "‚úÖ Stryker completed successfully"
                  } catch {
                    Write-Host "‚ùå Stryker failed with error: $($_.Exception.Message)"
                    Write-Host "üîß Check logs for details; consider reducing concurrency or increasing timeout"
                    throw
                  }
              continue-on-error: true

            - name: Verify Stryker report files
              shell: pwsh
              run: |
                  $expectedFiles = @(
                    "coverage/stryker.json",
                    "coverage/stryker.html",
                    "coverage/events",
                    "reports/stryker-incremental.json"
                  )
                  $missing = $expectedFiles | Where-Object { -not (Test-Path $_) }
                  if ($missing.Count -gt 0) {
                    Write-Host "‚ö†Ô∏è Warning: The following Stryker report files are missing:`n$($missing -join "`n")"
                  } else {
                    Write-Host "‚úÖ All expected Stryker report files are present."
                  }

            - name: Upload mutation testing reports
              if: always() # Upload reports even if Stryker fails
              uses: actions/upload-artifact@ef09cdac3e2d3e60d8ccadda691f4f1cec5035cb # v5.0.0
              with:
                  name: stryker-reports-${{ github.sha }}
                  path: |
                      coverage/stryker.json
                      coverage/stryker.html
                      coverage/events
                      reports/stryker-incremental.json
                  retention-days: ${{ fromJSON(github.event.inputs.artifact-retention-days || '30') }}

            # Adds a comment to the pull request summarizing mutation testing results.
            # Reads the Stryker mutation report, calculates the mutation score, and posts a status comment.
            # If the report is missing, notifies the PR with a warning and instructions.
            - name: Comment mutation score on PR
              if: always() && github.event_name == 'pull_request'
              uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
              with:
                  script: |
                      const fs = require('fs');
                      const path = require('path');
                      const reportPath = path.join('coverage', 'stryker.json');

                      let comment;
                      if (fs.existsSync(reportPath)) {
                        const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
                        const score = Math.round(report.mutationScore || 0);

                        let scoreStatus;
                        if (score >= 85) {
                          scoreStatus = 'üü¢ Excellent mutation coverage!';
                        } else if (score >= 70) {
                          scoreStatus = 'üü° Good mutation coverage';
                        } else {
                          scoreStatus = 'üî¥ Mutation coverage needs improvement';
                        }

                        // Sanitize branch name for dashboard URL
                        const rawBranch = process.env.GITHUB_REF_NAME || process.env.GITHUB_REF || '';
                        const safeBranch = rawBranch.replace(/[^a-zA-Z0-9._-]/g, '-');
                        const repo = process.env.GITHUB_REPOSITORY || '';
                        const sha = process.env.GITHUB_SHA || '';
                        const dashboardUrl = `https://dashboard.stryker-mutator.io/reports/github.com/${repo}/${safeBranch}-${sha}`;

                        comment = `## üß¨ Mutation Testing Results

                        **Mutation Score:** ${score}%

                        üìä [View detailed report](${dashboardUrl})

                        ${scoreStatus}
                        `;
                      } else {
                        comment = `## üß¨ Mutation Testing Results

                        ‚ö†Ô∏è Mutation report not found. Mutation testing results are unavailable for this PR.

                        Please check the workflow logs for details or re-run the mutation testing workflow if needed.
                        `;
                      }

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: comment
                      });

            # MODIFIED: Update final check to handle cases where Stryker was skipped due to test failures or produced invalid output
            - name: Check mutation score threshold
              if: always()
              shell: pwsh
              run: |
                  $mutationReport = "coverage/stryker.json"
                  $threshold = "${{ github.event.inputs.mutation-score-threshold }}"
                  if ([string]::IsNullOrEmpty($threshold)) {
                    $threshold = "60"
                  }
                  $thresholdInt = [int]$threshold

                  if (Test-Path $mutationReport) {
                    try {
                      $jsonContent = Get-Content $mutationReport -Raw
                      $report = $jsonContent | ConvertFrom-Json
                      $score = $report.mutationScore
                      if ($null -eq $score) { $score = 0 }
                      Write-Host "üß¨ Mutation score: $score%"
                      if ($score -lt $thresholdInt) {
                        Write-Host "‚ùå Mutation score $score% is below the minimum threshold of $thresholdInt%"
                        $repo = $env:GITHUB_REPOSITORY
                        $refName = $env:GITHUB_REF_NAME
                        $sha = $env:GITHUB_SHA
                        $reportUrl = "https://dashboard.stryker-mutator.io/reports/github.com/$repo/$refName-$sha"
                        Write-Host "üîç Check the detailed report for areas that need better test coverage: $reportUrl"
                        exit 1
                      } else {
                        Write-Host "‚úÖ Mutation score $score% meets the quality threshold ($thresholdInt%)"
                      }
                    } catch {
                      Write-Host "‚ö†Ô∏è Error parsing mutation report JSON: $($_.Exception.Message)"
                      Write-Host "üîß Please check the mutation report file for validity."
                      exit 1
                    }
                  } elseif ("${{ steps.run-tests.outcome }}" -ne "success") {
                    Write-Host "‚ö†Ô∏è Test suite failed - Stryker was skipped to avoid unreliable mutation results"
                    Write-Host "üîß Fix the failing tests before running mutation testing"
                    exit 1
                  } else {
                    Write-Host "‚ö†Ô∏è No mutation report found - Stryker may have failed to complete"
                    exit 1
                  }
