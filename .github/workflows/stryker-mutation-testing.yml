name: Stryker Mutation Testing

# Run on pushes to main and PRs, plus manual trigger
on:
    push:
        branches: [main]
        paths:
            # Only run when source code changes
            - "src/**"
            - "electron/**"
            - "shared/**"
            - "package.json"
            - "package-lock.json"
            - "stryker.config.mjs"
            - "vitest.config.ts"
            - "tsconfig*.json"
    pull_request:
        branches: [main]
        paths:
            - "src/**"
            - "electron/**"
            - "shared/**"
            - "package.json"
            - "package-lock.json"
            - "stryker.config.mjs"
            - "vitest.config.ts"
            - "tsconfig*.json"
    workflow_dispatch:
        inputs:
            branch:
                description: "Branch to run mutation testing against"
                required: true
                default: "main"

# Limit concurrency to avoid running multiple mutation tests simultaneously
concurrency:
    group: stryker-${{ github.ref }}
    cancel-in-progress: true

permissions:
    contents: read
    issues: write
    pull-requests: write

jobs:
    mutation-testing:
        name: Run Stryker Mutation Testing
        runs-on: ubuntu-latest
        timeout-minutes: 60 # Mutation testing can take a while

        steps:
            - name: Harden the runner
              uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
              with:
                  egress-policy: audit

            - name: Checkout repository
              uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
              with:
                  ref: ${{ github.event.inputs.branch || github.ref }}
                  # Fetch full history for better incremental mode performance
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Cache Stryker incremental file
              uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
              with:
                  path: reports/stryker-incremental.json
                  key: stryker-incremental-${{ github.sha }}
                  restore-keys: |
                      stryker-incremental-${{ github.ref_name }}-
                      stryker-incremental-

            - name: Install dependencies
              run: npm ci

            - name: Create reports directory
              run: mkdir -p reports/mutation

            - name: Run Stryker mutation testing
              env:
                  # üîë Dashboard API Key - Set this as a repository secret
                  STRYKER_DASHBOARD_API_KEY: ${{ secrets.STRYKER_DASHBOARD_API_KEY }}
                  # üìä GitHub Actions automatically provides these for dashboard reporting
                  # GITHUB_REPOSITORY and GITHUB_SHA are automatically available
                  CI: true
              run: |
                  echo "üß¨ Starting Stryker mutation testing..."
                  echo "üìä Project: github.com/${{ github.repository }}"
                  echo "üè∑Ô∏è Version: ${{ github.ref_name }}-${{ github.sha }}"
                  echo "üìÅ Reports will be saved to: reports/mutation/"

                  # Run Stryker with dashboard reporting enabled
                  npx stryker run --concurrency 4
              continue-on-error: true # Don't fail the build if mutation score is below threshold

            - name: Upload mutation testing reports
              if: always() # Upload reports even if Stryker fails
              uses: actions/upload-artifact@ef09cdac3e2d3e60d8ccadda691f4f1cec5035cb # v5.0.0
              with:
                  name: stryker-reports-${{ github.sha }}
                  path: |
                      reports/mutation/
                      reports/stryker-incremental.json
                      coverage/stryker.json
                      coverage/stryker.html
                      coverage/events
                  retention-days: 30

            - name: Comment mutation score on PR
              if: github.event_name == 'pull_request' && always()
              uses: actions/github-script@v8
              with:
                  script: |
                      const fs = require('fs');
                      const path = 'coverage/stryker.json';

                      if (fs.existsSync(path)) {
                        const report = JSON.parse(fs.readFileSync(path, 'utf8'));
                        const score = Math.round(report.thresholds?.high || 0);

                        const comment = `## üß¨ Mutation Testing Results

                        **Mutation Score:** ${score}%

                        üìä [View detailed report](https://dashboard.stryker-mutator.io/reports/github.com/${{ github.repository }}/${{ github.ref_name }}-${{ github.sha }})

                        ${score >= 85 ? 'üü¢ Excellent mutation coverage!' :
                          score >= 70 ? 'üü° Good mutation coverage' :
                          'üî¥ Mutation coverage needs improvement'}
                        `;

                        github.rest.issues.createComment({
                          issue_number: context.issue.number,
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          body: comment
                        });
                      }

            - name: Check mutation score threshold
              if: always()
              run: |
                  if [ -f "reports/mutation/mutation.json" ]; then
                    SCORE=$(cat reports/mutation/mutation.json | jq -r '.thresholds.high // 0')
                    echo "üß¨ Mutation score: ${SCORE}%"

                    if [ "$SCORE" -lt 60 ]; then
                      echo "‚ùå Mutation score ${SCORE}% is below the minimum threshold of 60%"
                      echo "üîç Check the detailed report for areas that need better test coverage"
                      exit 1
                    else
                      echo "‚úÖ Mutation score ${SCORE}% meets the quality threshold"
                    fi
                  else
                    echo "‚ö†Ô∏è No mutation report found - Stryker may have failed to complete"
                    exit 1
                  fi
