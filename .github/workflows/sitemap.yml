# yaml-language-server: $schema=https://www.schemastore.org/github-workflow.json
name: GitHub Pages - Generate XML sitemap

# Trigger the workflow manually or on a push event
on:
    workflow_dispatch:

concurrency:
    group: sitemap-${{ github.ref }}
    cancel-in-progress: false

jobs:
    sitemap_job:
        runs-on: ubuntu-latest
        name: Generate a sitemap

        steps:
            # Step to harden the runner for security purposes
            - name: Harden Runner
              uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2 # v2.13.3
              with:
                  disable-sudo: true
                  egress-policy: audit
                  allowed-endpoints: >
                      github.com:443

            # Step to checkout the repository
            - name: Checkout the repo
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
              with:
                  fetch-depth: 0

            # Step to generate the sitemap using the cicirello/generate-sitemap action
            - name: Generate the sitemap
              id: sitemap
              uses: cicirello/generate-sitemap@6a56a20238e631d653600cf792c3596722b78259 # v1.10.4
              with:
                  base-url-path: https://Uptime-Watcher.typpi.online/
                  additional-extensions: doc docx ppt pptx js css json xml xlsx xls pdf md markdown txt lua yaml yml png

            # Step to output the sitemap generation stats for debugging and verification
            - name: Output stats
              run: |
                  echo "sitemap-path = ${{ steps.sitemap.outputs.sitemap-path }}"
                  echo "url-count = ${{ steps.sitemap.outputs.url-count }}"
                  echo "excluded-count = ${{ steps.sitemap.outputs.excluded-count }}"

            # Step to create a pull request with the new sitemap
            - name: Create Pull Request with new SiteMap
              id: create_pr
              uses: peter-evans/create-pull-request@84ae59a2cdc2258d6fa0732dd66352dddae2a412 # v7.0.9
              with:
                  title: "Automated sitemap update"
                  body: >
                      Sitemap updated by the [generate-sitemap](https://github.com/cicirello/generate-sitemap)
                      GitHub action. Automated pull-request generated by the
                      [create-pull-request](https://github.com/peter-evans/create-pull-request) GitHub action.

            # Step to set the pull request number or ID as an environment variable
            - name: Set pull request number or ID
              id: set_pr_number
              run: |
                  pr_number=$(gh pr list --state open --base main --json number -q '.[0].number')
                  if [ -n "$pr_number" ]; then
                    echo "PR_NUMBER=$pr_number" >> "$GITHUB_ENV"
                  else
                    echo "PR_NUMBER=" >> "$GITHUB_ENV"
                  fi
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
