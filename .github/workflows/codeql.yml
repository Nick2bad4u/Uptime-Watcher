# -----------------------------------------------
# CodeQL Workflow Review & Suggestions
#
# Step-by-step review:
# - Trigger Conditions:
#   - Triggers on push, pull_request, workflow_dispatch, and weekly schedule.
#   - Paths to ignore: docs, tests, assets, etc.
# - Permissions:
#   - contents: read, security-events: write (standard for CodeQL).
# - Job Configuration:
#   - Runs on ubuntu-latest, 120-min timeout.
#   - Concurrency cancels in-progress runs for same ref.
#   - Matrix: javascript, typescript (matches stack).
# - Steps:
#   - Harden runner (security best practice).
#   - Checkout repo (full history, no credential persistence).
#   - Initialize CodeQL for matrix languages.
#   - Setup Node.js v24 (current LTS).
#   - Cache node_modules for faster builds.
#   - Install dependencies with npm ci --force (robust for CI).
#   - Build Electron Vite project (matches architecture).
#   - Package/upload CodeQL DBs for debugging (optional, non-fatal).
#   - Perform CodeQL analysis.
#
# Suggestions / Missing Items:
# - Build Step:
#   - Confirm npm run build:electron-vite builds both main/renderer for full analysis.
#   - Include native/custom build steps if needed.
# - Artifacts:
#   - CodeQL DBs uploaded for debugging. SARIF results are default for GitHub Security tab.
# - Node Modules Cache:
#   - Consider caching .vite or other build artifacts if builds are slow.
# - Security:
#   - step-security/harden-runner used for outbound call auditing.
# - Languages:
#   - Only javascript/typescript included. Add others (e.g., Python) if needed.
# - Custom Queries:
#   - Add custom queries to Initialize CodeQL step if desired.
# - Notifications:
#   - No notification step for failures (Slack/email). Add if needed.
# - Dependency Installation:
#   - continue-on-error: true for npm ci/build means analysis runs even if install/build fails (may be incomplete).
# -----------------------------------------------

# For most projects, this workflow file will not need changing; you simply need
# to commit it to your repository.
#
# You may wish to alter this file to override the set of languages analyzed,
# or to provide custom queries or build logic.
#
# ******** NOTE ********
# We have attempted to detect the languages in your repository. Please check
# the `language` matrix defined below to confirm you have the correct set of
# supported CodeQL languages.
#
name: "CodeQL"

on:
    push:
        branches: [main]
        paths-ignore:
            - ".github/**"
            - "**/docs/**"
            - "**/test/**"
            - "**/tests/**"
            - "**/benchmarks/**"
            - "**/icons/**"
            - "**/scripts/**"
            - "**/public/**"
            - "**/assets/**"
            - "**/.vscode/**"
    pull_request:
        branches: [main]
        paths-ignore:
            - ".github/**"
            - "**/docs/**"
            - "**/test/**"
            - "**/tests/**"
            - "**/benchmarks/**"
            - "**/icons/**"
            - "**/scripts/**"
            - "**/public/**"
            - "**/assets/**"
            - "**/.vscode/**"
    workflow_dispatch:
    schedule:
        - cron: "44 2 * * 4" # run once a week on Thursday at 2:44 AM UTC

permissions:
    contents: read
    security-events: write

jobs:
    analyze:
        name: Analyze
        runs-on: ubuntu-latest
        timeout-minutes: 120
        permissions:
            actions: read
            contents: read
            security-events: write

        concurrency:
            group: codeql-${{ github.ref }}-${{ matrix.language }}
            cancel-in-progress: true

        strategy:
            fail-fast: false
            matrix:
                language: ["javascript", "typescript"]
                # CodeQL supports [ $supported-codeql-languages ]
                # Learn more about CodeQL language support at https://aka.ms/codeql-docs/language-support

        steps:
            - name: Harden the runner (Audit all outbound calls)
              uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
              with:
                  egress-policy: audit

            - name: Checkout repository
              uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
              with:
                  fetch-depth: 0
                  persist-credentials: false

            # Initializes the CodeQL tools for scanning.
            - name: Initialize CodeQL
              uses: github/codeql-action/init@2d92b76c45b91eb80fc44c74ce3fce0ee94e8f9d # v3.29.5
              with:
                  languages: ${{ matrix.language }}
                  source-root: .
                  # keep the default useful packs/queries
                  queries: security-and-quality

            - name: Set up Node.js
              uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
              with:
                  node-version: 24
                  cache: "npm"

            - name: Cache node modules
              uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
              with:
                  path: ./node_modules
                  key: ${{ runner.os }}-.-node-modules-${{ hashFiles('./package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-.-node-modules-
              continue-on-error: true # If this fails, the analysis will still run, but it may not be complete.

            - name: Install dependencies
              run: npm ci --force
              continue-on-error: true # If this fails, the analysis will still run, but it may not be complete.

            # Autobuild attempts to build any compiled languages  (C/C++, C#, or Java).
            # If this step fails, then you should remove it and run the build manually (see below)
            - name: Build Electron Vite Project
              run: npm run build:electron-vite
              continue-on-error: true

            # Optional: package any generated CodeQL DBs for debugging (non-fatal)
            - name: Package CodeQL DBs (debug)
              run: |
                  set -e
                  # create tarballs if CodeQL DB folders exist (Linux/macOS runner)
                  if [ -d "./codeql-databases" ]; then tar -czf codeql-databases.tgz ./codeql-databases || true; fi
                  if [ -d "./codeql-db" ]; then tar -czf codeql-db.tgz ./codeql-db || true; fi
              shell: bash
              continue-on-error: true

            - name: Upload CodeQL DBs (debug)
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: codeql-databases-${{ matrix.language }}
                  path: |
                      codeql-databases.tgz
                      codeql-db.tgz
              continue-on-error: true

            # ‚ÑπÔ∏è Command-line programs to run using the OS shell.
            # üìö See https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idstepsrun

            - name: Perform CodeQL Analysis
              uses: github/codeql-action/analyze@2d92b76c45b91eb80fc44c74ce3fce0ee94e8f9d # v3.29.5
              with:
                  category: "/language:${{matrix.language}}"
