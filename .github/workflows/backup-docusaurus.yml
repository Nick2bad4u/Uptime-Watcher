# Build and backup Docusaurus documentation to backup repository
# yaml-language-server: $schema=https://www.schemastore.org/github-workflow.json
name: Build and Backup Docusaurus Documentation

on:
    # Runs on pushes targeting the default branch when docs/docusaurus changes
    push:
        branches: ["main"]
        paths:
            - "docs/docusaurus/**"
            - "electron/**"
            - "shared/**"
            - "src/**"
            - ".github/workflows/backup-docusaurus.yml"

    # Allows you to run this workflow manually from the Actions tab
    workflow_dispatch:

# Sets permissions for the GITHUB_TOKEN
permissions:
    contents: write
    actions: read

# Prevent concurrent backup runs
concurrency:
    group: "docusaurus-backup"
    cancel-in-progress: true

jobs:
    build-and-backup:
        name: Build and Backup Documentation
        runs-on: ubuntu-latest
        env:
            DOCUSAURUS_BACKUP_REPO: Nick2bad4u/Uptime-Watcher-Docusaurus
            DOCUSAURUS_BACKUP_BRANCH: main

        steps:
            - name: Harden the runner (Audit all outbound calls)
              uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
              with:
                  egress-policy: audit

            - name: Checkout repository
              uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
              with:
                  fetch-depth: 0 # Need full history for git subtree operations
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup Node.js
              uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
              with:
                  node-version: "latest"
                  cache: "npm"

            - name: Cache dependencies and build artifacts
              uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5.0.2
              with:
                  path: |
                      node_modules
                      ~/.npm
                      docs/docusaurus/node_modules
                      docs/docusaurus/.cache
                      .cache
                      node_modules/.cache
                      docs/docusaurus/node_modules/.cache
                      docs/docusaurus/build/.cache
                      **/.rspack-cache
                      **/.webpack-cache
                  key: ${{ runner.os }}-backup-build-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('docs/docusaurus/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-backup-build-${{ hashFiles('**/package-lock.json') }}-
                      ${{ runner.os }}-backup-build-

            - name: Configure Git
              run: |
                  git config --global user.name "github-actions[bot]"
                  git config --global user.email "github-actions[bot]@users.noreply.github.com"

            - name: Install dependencies - Main App
              run: npm install --force

            - name: Install dependencies - Docusaurus
              run: cd docs/docusaurus && npm install --force

            - name: Check for changes in docs/docusaurus
              id: check_changes
              run: |
                  # Check if there are any changes in relevant directories in the current push
                  if git diff --name-only ${{ github.event.before }}..${{ github.event.after }} | grep -qE "^(docs/docusaurus/|electron/|shared/|src/)"; then
                      echo "changes=true" >> $GITHUB_OUTPUT
                      echo "âœ… Changes detected in documentation-related directories"
                  else
                      echo "changes=false" >> $GITHUB_OUTPUT
                      echo "â„¹ï¸ No changes detected in documentation-related directories"
                  fi

            - name: Build before TypeDoc
              if: steps.check_changes.outputs.changes == 'true' || github.event_name == 'workflow_dispatch'
              run: |
                  echo "ðŸ—ï¸ Building main application..."
                  # Build files
                  npm run build:electron-vite

            - name: Generate unified TypeDoc documentation
              if: steps.check_changes.outputs.changes == 'true' || github.event_name == 'workflow_dispatch'
              run: |
                  echo "ðŸ“š Generating TypeDoc documentation..."
                  # Generate unified TypeDoc documentation for all source code (Frontend, Backend, Shared)
                  npm run docs:typedoc
              continue-on-error: true

            - name: Build Docusaurus website
              if: steps.check_changes.outputs.changes == 'true' || github.event_name == 'workflow_dispatch'
              run: |
                  echo "ðŸ”¨ Building Docusaurus website..."
                  npm run docusaurus:build
                  echo "âœ… Docusaurus build completed"

            - name: List build output
              if: steps.check_changes.outputs.changes == 'true' || github.event_name == 'workflow_dispatch'
              run: |
                  echo "ðŸ“ Build output contents:"
                  if [ -d "docs/docusaurus/build" ]; then
                      ls -la docs/docusaurus/build/
                  else
                      echo "âŒ Build directory not found"
                  fi

            - name: Ensure backup token is configured
              if: steps.check_changes.outputs.changes == 'true' || github.event_name == 'workflow_dispatch'
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  if [ -z "${GITHUB_TOKEN}" ]; then
                      echo "âŒ GITHUB_TOKEN secret is not configured."
                      echo "Please add a classic PAT with repo:status, repo_deployment, public_repo, and workflow scopes."
                      exit 1
                  fi

                        - name: Clone backup repository
                            if: steps.check_changes.outputs.changes == 'true' || github.event_name == 'workflow_dispatch'
                            env:
                                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                            run: |
                                    echo "ðŸ“¥ Cloning backup repository ${{ env.DOCUSAURUS_BACKUP_REPO }}..."
                                    rm -rf backup-repo
                                    git clone --depth=1 "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ env.DOCUSAURUS_BACKUP_REPO }}" backup-repo
                                    cd backup-repo
                                    git checkout ${{ env.DOCUSAURUS_BACKUP_BRANCH }} 2>/dev/null || git checkout -b ${{ env.DOCUSAURUS_BACKUP_BRANCH }}

            - name: Sync documentation artifacts to backup repository
              if: steps.check_changes.outputs.changes == 'true' || github.event_name == 'workflow_dispatch'
              run: |
                  echo "ðŸ§½ Cleaning tracked files in backup repository"
                  rsync -a --delete \
                      --exclude '.git/' \
                      --exclude 'node_modules/' \
                      --exclude '.cache/' \
                      --exclude 'build/.cache/' \
                      docs/docusaurus/ backup-repo/

            - name: Commit and push backup repository
              if: steps.check_changes.outputs.changes == 'true' || github.event_name == 'workflow_dispatch'
              working-directory: backup-repo
              run: |
                  echo "ðŸ“ Preparing backup commit"
                  git add --all
                  if git diff --staged --quiet; then
                      echo "â„¹ï¸ No documentation changes detected after sync."
                      exit 0
                  fi

                  git commit -m "ðŸ“š Auto-backup: Docusaurus artifacts from ${{ github.sha }}" || true
                  echo "ðŸš€ Pushing to backup repository"
                  git push origin ${{ env.DOCUSAURUS_BACKUP_BRANCH }}

            - name: Summary
              if: always()
              run: |
                  echo "## ðŸ“š Docusaurus Build & Backup Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  if [[ "${{ steps.check_changes.outputs.changes }}" == "true" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
                      echo "âœ… **Status**: Successfully built and backed up" >> $GITHUB_STEP_SUMMARY
                      echo "ðŸ—ï¸ **Build**: Includes production build artifacts" >> $GITHUB_STEP_SUMMARY
                      echo "ðŸ“ **Source**: \`docs/docusaurus/\` (with build folder)" >> $GITHUB_STEP_SUMMARY
                      echo "ðŸŽ¯ **Target**: Backup repository \`main\` branch" >> $GITHUB_STEP_SUMMARY
                      echo "âš¡ **Build Overrides**: Gitignore bypassed for build artifacts" >> $GITHUB_STEP_SUMMARY
                      echo "â° **Triggered**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

                      if [ -d "docs/docusaurus/build" ]; then
                          echo "ðŸ“Š **Build Size**: $(du -sh docs/docusaurus/build 2>/dev/null | cut -f1 || echo 'Unknown')" >> $GITHUB_STEP_SUMMARY
                      fi
                  else
                      echo "â„¹ï¸ **Status**: Skipped (no changes detected)" >> $GITHUB_STEP_SUMMARY
                      echo "ðŸ“ **Source**: \`docs/docusaurus/\`" >> $GITHUB_STEP_SUMMARY
                      echo "â° **Triggered**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
                  fi

                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### ðŸ”§ Process Details" >> $GITHUB_STEP_SUMMARY
                  echo "1. **TypeDoc Generation**: API documentation from source code" >> $GITHUB_STEP_SUMMARY
                  echo "2. **Docusaurus Build**: Static site generation" >> $GITHUB_STEP_SUMMARY
                  echo "3. **Gitignore Override**: Force-added build artifacts" >> $GITHUB_STEP_SUMMARY
                  echo "4. **Subtree Push**: Deployed to backup repository" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "---" >> $GITHUB_STEP_SUMMARY
                  echo "*Last updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*" >> $GITHUB_STEP_SUMMARY
