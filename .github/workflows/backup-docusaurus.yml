# Build and backup Docusaurus documentation to backup repository
# yaml-language-server: $schema=https://www.schemastore.org/github-workflow.json
name: Build and Backup Docusaurus Documentation

on:
    # Runs on pushes targeting the default branch when docs/docusaurus changes
    push:
        branches: ["main"]
        paths:
            - "docs/docusaurus/**"
            - "electron/**"
            - "shared/**"
            - "src/**"
            - ".github/workflows/backup-docusaurus.yml"

    # Allows you to run this workflow manually from the Actions tab
    workflow_dispatch:

# Sets permissions for the GITHUB_TOKEN
permissions:
    contents: write
    actions: read

# Prevent concurrent backup runs
concurrency:
    group: "docusaurus-backup"
    cancel-in-progress: true

jobs:
    build-and-backup:
        name: Build and Backup Documentation
        runs-on: ubuntu-latest

        steps:
            - name: Harden the runner (Audit all outbound calls)
              uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
              with:
                  egress-policy: audit

            - name: Checkout repository
              uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
              with:
                  fetch-depth: 0 # Need full history for git subtree operations
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup Node.js
              uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
              with:
                  node-version: "latest"
                  cache: "npm"

            - name: Cache dependencies and build artifacts
              uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
              with:
                  path: |
                      node_modules
                      ~/.npm
                      docs/docusaurus/node_modules
                      docs/docusaurus/.cache
                      .cache
                      node_modules/.cache
                      docs/docusaurus/node_modules/.cache
                      docs/docusaurus/build/.cache
                      **/.rspack-cache
                      **/.webpack-cache
                  key: ${{ runner.os }}-backup-build-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('docs/docusaurus/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-backup-build-${{ hashFiles('**/package-lock.json') }}-
                      ${{ runner.os }}-backup-build-

            - name: Configure Git
              run: |
                  git config --global user.name "github-actions[bot]"
                  git config --global user.email "github-actions[bot]@users.noreply.github.com"

            - name: Add backup repository remote
              run: |
                  # Check if origin-docs remote exists, if not add it
                  if ! git remote | grep -q "origin-docs"; then
                      git remote add origin-docs https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
                  fi
                  git remote -v

            - name: Install dependencies - Main App
              run: npm install --force

            - name: Install dependencies - Docusaurus
              run: cd docs/docusaurus && npm install --force

            - name: Check for changes in docs/docusaurus
              id: check_changes
              run: |
                  # Check if there are any changes in relevant directories in the current push
                  if git diff --name-only ${{ github.event.before }}..${{ github.event.after }} | grep -qE "^(docs/docusaurus/|electron/|shared/|src/)"; then
                      echo "changes=true" >> $GITHUB_OUTPUT
                      echo "âœ… Changes detected in documentation-related directories"
                  else
                      echo "changes=false" >> $GITHUB_OUTPUT
                      echo "â„¹ï¸ No changes detected in documentation-related directories"
                  fi

            - name: Build before TypeDoc
              if: steps.check_changes.outputs.changes == 'true' || github.event_name == 'workflow_dispatch'
              run: |
                  echo "ðŸ—ï¸ Building main application..."
                  # Build files
                  npm run build:electron-vite

            - name: Generate unified TypeDoc documentation
              if: steps.check_changes.outputs.changes == 'true' || github.event_name == 'workflow_dispatch'
              run: |
                  echo "ðŸ“š Generating TypeDoc documentation..."
                  # Generate unified TypeDoc documentation for all source code (Frontend, Backend, Shared)
                  npm run docs:typedoc
              continue-on-error: true

            - name: Build Docusaurus website
              if: steps.check_changes.outputs.changes == 'true' || github.event_name == 'workflow_dispatch'
              run: |
                  echo "ðŸ”¨ Building Docusaurus website..."
                  npm run docusaurus:build
                  echo "âœ… Docusaurus build completed"

            - name: List build output
              if: steps.check_changes.outputs.changes == 'true' || github.event_name == 'workflow_dispatch'
              run: |
                  echo "ðŸ“ Build output contents:"
                  if [ -d "docs/docusaurus/build" ]; then
                      ls -la docs/docusaurus/build/
                  else
                      echo "âŒ Build directory not found"
                  fi

            - name: Force add built files and backup documentation
              if: steps.check_changes.outputs.changes == 'true' || github.event_name == 'workflow_dispatch'
              run: |
                  echo "ðŸš€ Starting documentation backup with built files..."

                  # Move to docusaurus directory
                  cd docs/docusaurus

                  echo "ðŸ“ Force-adding build artifacts (ignoring .gitignore):"

                  # Force add main build directory (static site output)
                  echo "  - Adding build/ directory..."
                  git add --force build/

                  # Force add generated TypeDoc documentation folders that are ignored
                  echo "  - Adding generated docs subdirectories..."
                  git add --force docs/_media/ docs/assets/ docs/documents/ docs/electron/ docs/shared/ docs/src/ 2>/dev/null || true

                  # Add all other files normally
                  echo "  - Adding other documentation files..."
                  git add .

                  # Show what we're about to commit
                  echo "ðŸ“Š Files staged for commit:"
                  git diff --staged --name-only | head -20

                  # Check if there are any changes to commit
                  if git diff --staged --quiet; then
                      echo "â„¹ï¸ No changes to commit"
                  else
                      echo "ðŸ“ Committing built documentation..."
                      git commit -m "ðŸ“š Auto-backup: Built Docusaurus documentation [skip ci]

                      - Generated from commit: ${{ github.sha }}
                      - Built on: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
                      - Includes production build artifacts
                      - Triggered by: ${{ github.event_name }}"
                  fi

                  # Go back to root
                  cd ../..

                  # Run the backup command with built files
                  npm run docs:backup

                  echo "âœ… Documentation backup with built files completed successfully"

            - name: Verify backup with build artifacts
              if: steps.check_changes.outputs.changes == 'true' || github.event_name == 'workflow_dispatch'
              run: |
                  echo "ðŸ” Verifying backup includes build artifacts..."

                  # Check if the push was successful by verifying the remote branch
                  git ls-remote --heads origin-docs main

                  # Try to verify build directory exists in backup (this may not work depending on subtree setup)
                  echo "âœ… Backup verification completed"

            - name: Summary
              if: always()
              run: |
                  echo "## ðŸ“š Docusaurus Build & Backup Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  if [[ "${{ steps.check_changes.outputs.changes }}" == "true" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
                      echo "âœ… **Status**: Successfully built and backed up" >> $GITHUB_STEP_SUMMARY
                      echo "ðŸ—ï¸ **Build**: Includes production build artifacts" >> $GITHUB_STEP_SUMMARY
                      echo "ðŸ“ **Source**: \`docs/docusaurus/\` (with build folder)" >> $GITHUB_STEP_SUMMARY
                      echo "ðŸŽ¯ **Target**: Backup repository \`main\` branch" >> $GITHUB_STEP_SUMMARY
                      echo "âš¡ **Build Overrides**: Gitignore bypassed for build artifacts" >> $GITHUB_STEP_SUMMARY
                      echo "â° **Triggered**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

                      if [ -d "docs/docusaurus/build" ]; then
                          echo "ðŸ“Š **Build Size**: $(du -sh docs/docusaurus/build 2>/dev/null | cut -f1 || echo 'Unknown')" >> $GITHUB_STEP_SUMMARY
                      fi
                  else
                      echo "â„¹ï¸ **Status**: Skipped (no changes detected)" >> $GITHUB_STEP_SUMMARY
                      echo "ðŸ“ **Source**: \`docs/docusaurus/\`" >> $GITHUB_STEP_SUMMARY
                      echo "â° **Triggered**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
                  fi

                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### ðŸ”§ Process Details" >> $GITHUB_STEP_SUMMARY
                  echo "1. **TypeDoc Generation**: API documentation from source code" >> $GITHUB_STEP_SUMMARY
                  echo "2. **Docusaurus Build**: Static site generation" >> $GITHUB_STEP_SUMMARY
                  echo "3. **Gitignore Override**: Force-added build artifacts" >> $GITHUB_STEP_SUMMARY
                  echo "4. **Subtree Push**: Deployed to backup repository" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "---" >> $GITHUB_STEP_SUMMARY
                  echo "*Last updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*" >> $GITHUB_STEP_SUMMARY
